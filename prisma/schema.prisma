generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTICATION (NextAuth.js)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CORE ENTITIES
// ============================================

model User {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Auth fields
  email         String    @unique
  emailVerified DateTime?
  password      String?   // For credentials auth
  name          String
  image         String?
  
  // Guardian-specific fields
  role          String    @default("rep") // rep, manager, admin
  phone         String?
  avatarUrl     String?
  isActive      Boolean   @default(true)
  
  // Performance Metrics (aggregated)
  totalDeals        Int      @default(0)
  totalRevenue      Float    @default(0)
  avgDealSize       Float    @default(0)
  closeRate         Float    @default(0)
  monthlyTarget     Float    @default(0)
  
  // Team hierarchy
  managerId     String?
  manager       User?     @relation("TeamHierarchy", fields: [managerId], references: [id])
  teamMembers   User[]    @relation("TeamHierarchy")
  
  // Relationships
  accounts          Account[]
  sessions          Session[]
  customers         Customer[]
  interactions      Interaction[]
  notes             Note[]
  activities        Activity[]
  conversations     Conversation[]
  pushSubscriptions PushSubscription[]
  playbookUsages    PlaybookUsage[]
  playbookFavorites PlaybookFavorite[]
  playbookRatings   PlaybookRating[]

  // Scheduled Decks (batch processing)
  scheduledDecksRequested ScheduledDeck[] @relation("ScheduledDecksRequested")
  scheduledDecksAssigned  ScheduledDeck[] @relation("ScheduledDecksAssigned")
}

model Customer {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Basic Info
  firstName     String
  lastName      String
  email         String?
  phone         String?
  altPhone      String?
  
  // Property Info
  address       String
  city          String
  state         String
  zipCode       String
  county        String?
  latitude      Float?
  longitude     Float?
  
  // Property Details (gathered from APIs)
  propertyType      String?   // single-family, multi-family, commercial
  yearBuilt         Int?
  squareFootage     Int?
  lotSize           Float?    // acres
  stories           Int?
  bedrooms          Int?
  bathrooms         Float?
  
  // Roof Details
  roofType          String?   // asphalt shingle, metal, tile, etc.
  roofAge           Int?      // estimated years
  roofSquares       Int?      // roofing squares
  roofPitch         String?   // 4/12, 6/12, etc.
  lastRoofWork      DateTime?
  roofCondition     String?   // excellent, good, fair, poor
  
  // Financial
  propertyValue     Float?
  estimatedJobValue Float?
  
  // Insurance Intel
  insuranceCarrier  String?
  policyNumber      String?
  policyType        String?
  deductible        Float?
  claimHistory      Int       @default(0) // number of prior claims
  
  // Scores & Analytics
  leadScore         Int       @default(0)  // 0-100
  urgencyScore      Int       @default(0)  // 0-100  
  profitPotential   Float     @default(0)  // estimated $
  churnRisk         Int       @default(0)  // 0-100
  engagementScore   Int       @default(0)  // 0-100
  
  // Status
  status            String    @default("lead") // lead, prospect, customer, closed-won, closed-lost
  stage             String    @default("new")  // new, contacted, qualified, proposal, negotiation, closed
  lostReason        String?
  
  // Source tracking
  leadSource        String?   // canvassing, referral, storm, online, etc.
  referredBy        String?
  campaign          String?
  
  // CRM Sync
  crmId             String?   // External CRM ID
  crmSource         String?   // hubspot, salesforce, jobnimbus
  lastCrmSync       DateTime?
  
  // Relationships
  assignedRepId     String?
  assignedRep       User?     @relation(fields: [assignedRepId], references: [id])
  
  interactions      Interaction[]
  weatherEvents     WeatherEvent[]
  documents         Document[]
  intelItems        IntelItem[]
  notes             Note[]
  claims            InsuranceClaim[]
  tasks             Task[]
  playbookUsages    PlaybookUsage[]
  canvassingPins    CanvassingPin[]

  // Performance indexes
  @@index([assignedRepId])
  @@index([leadScore])
  @@index([status, stage])
  @@index([zipCode])
}

// ============================================
// INTELLIGENCE GATHERING
// ============================================

model IntelItem {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  source        String   // api, web-search, manual, crm-sync, weather-api, property-api
  sourceId      String?  // external reference ID
  category      String   // property, insurance, weather, financial, social, news, market
  title         String
  content       String
  confidence    Int      @default(80) // 0-100 confidence score
  actionable    Boolean  @default(false)
  priority      String   @default("medium") // low, medium, high, critical
  
  metadata      String?  // JSON string for flexible data
  expiresAt     DateTime?
  isRead        Boolean  @default(false)
  isDismissed   Boolean  @default(false)
}

model WeatherEvent {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  // Can be linked to customer or standalone for area
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // Location
  latitude      Float
  longitude     Float
  zipCode       String?
  county        String?
  city          String?
  state         String?
  
  eventType     String   // hail, wind, tornado, hurricane, flood, thunderstorm
  eventDate     DateTime
  severity      String   // minor, moderate, severe, catastrophic
  
  // Hail specific
  hailSize      Float?   // inches
  hailDuration  Int?     // minutes
  
  // Wind specific
  windSpeed     Float?   // mph
  windGust      Float?   // mph
  windDirection String?
  
  // Damage assessment
  damageReported    Boolean @default(false)
  claimFiled        Boolean @default(false)
  inspectionDone    Boolean @default(false)
  estimatedDamage   Float?
  
  // Data source
  source        String   // NOAA, weather-api, manual, hail-trace
  sourceEventId String?  // External event ID
  rawData       String?  // JSON
  
  // Affected area
  affectedRadius Float?  // miles
  affectedCustomers Int  @default(0)

  // Performance indexes
  @@index([eventDate])
  @@index([zipCode])
}

model InsuranceClaim {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  claimNumber   String?
  carrier       String
  dateOfLoss    DateTime
  claimType     String   // roof, siding, gutters, full-exterior, interior
  
  status        String   @default("pending") // pending, approved, denied, supplement, paid, closed
  
  // Financials
  initialEstimate   Float?
  approvedValue     Float?
  supplementValue   Float?
  totalPaid         Float?
  deductible        Float?
  acv               Float?  // Actual Cash Value
  rcv               Float?  // Replacement Cost Value
  depreciation      Float?
  
  // Adjuster info
  adjusterName      String?
  adjusterPhone     String?
  adjusterEmail     String?
  adjusterCompany   String?
  inspectionDate    DateTime?
  reinspectionDate  DateTime?
  
  // Documents
  scopeOfWork       String?
  photos            String?  // JSON array of URLs
  
  notes         String?
  
  // Supplement tracking
  supplementCount   Int     @default(0)
  lastSupplementDate DateTime?
}

model PropertyData {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Address (unique identifier)
  address       String
  city          String
  state         String
  zipCode       String
  
  @@unique([address, city, state, zipCode])
  
  // Property details
  parcelNumber  String?
  ownerName     String?
  ownerMailingAddress String?
  
  propertyType  String?
  yearBuilt     Int?
  squareFootage Int?
  lotSize       Float?
  stories       Int?
  bedrooms      Int?
  bathrooms     Float?
  
  // Valuation
  assessedValue     Float?
  marketValue       Float?
  lastSalePrice     Float?
  lastSaleDate      DateTime?
  
  // Roof specific
  roofType      String?
  roofMaterial  String?
  roofYear      Int?
  roofCondition String?
  roofArea      Int?
  
  // Building materials
  exteriorWall  String?
  foundation    String?
  
  // Source tracking
  source        String   // zillow, county-records, attom, corelogic
  sourceId      String?
  rawData       String?  // JSON
  lastFetched   DateTime @default(now())
}

// ============================================
// INTERACTIONS & ACTIVITY
// ============================================

model Interaction {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  
  type          String   // call, email, text, visit, meeting, video-call
  direction     String   @default("outbound") // inbound, outbound
  subject       String?
  content       String?
  outcome       String?  // connected, voicemail, no-answer, scheduled, closed, callback
  sentiment     String?  // positive, neutral, negative
  
  duration      Int?     // seconds
  recordingUrl  String?
  
  nextAction    String?
  nextActionDate DateTime?
  
  // CRM sync
  crmId         String?
}

model Task {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  assignedToId  String
  createdById   String
  
  title         String
  description   String?
  type          String   // call, email, visit, follow-up, inspection, proposal, other
  priority      String   @default("medium") // low, medium, high, urgent
  status        String   @default("pending") // pending, in-progress, completed, cancelled
  
  dueDate       DateTime?
  completedAt   DateTime?
  
  // Reminders
  reminderDate  DateTime?
  reminderSent  Boolean  @default(false)
}

model Note {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  content       String
  isPinned      Boolean  @default(false)
  category      String?  // general, objection, follow-up, insight, competitor
}

model Document {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  name          String
  type          String   // contract, photo, estimate, inspection, insurance, proposal, other
  category      String?  // before, after, damage, signature
  url           String
  thumbnailUrl  String?
  size          Int?     // bytes
  mimeType      String?
  
  metadata      String?  // JSON
}

model Activity {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  type          String   // login, view, edit, call, email, create, delete
  entityType    String   // customer, lead, claim, document
  entityId      String?
  description   String
  
  metadata      String?  // JSON
  ipAddress     String?
  userAgent     String?
}

// ============================================
// PLAYBOOKS & KNOWLEDGE
// ============================================

model Playbook {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  title         String
  description   String?
  category      String   // objection-handling, closing, discovery, presentation, follow-up
  type          String   // script, checklist, guide, template
  
  content       String   // Markdown content
  
  // Targeting
  stage         String?  // Which pipeline stage this applies to
  scenario      String?  // Specific scenario (e.g., "homeowner hesitant", "adjuster pushback")
  
  // Dynamic variables (JSON) for placeholders like {CUSTOMER_NAME}
  variables     String?  // JSON object defining available variables
  
  // Metadata
  author        String?
  isPublished   Boolean  @default(true)
  usageCount    Int      @default(0)
  rating        Float?
  
  tags          String?  // JSON array
  
  // Relationships
  usages        PlaybookUsage[]
  favorites     PlaybookFavorite[]
  ratings       PlaybookRating[]
}

model PlaybookUsage {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  playbookId  String
  playbook    Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  context     String   // "practice", "customer_call", "meeting", "reference", "roleplay"
  duration    Int?     // seconds spent
  completed   Boolean  @default(false)
  outcome     String?  // "closed_won", "follow_up", "no_result", "objection_handled"
  
  @@index([playbookId])
  @@index([userId])
  @@index([customerId])
  @@index([createdAt])
}

model PlaybookFavorite {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  playbookId  String
  playbook    Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([playbookId, userId])
  @@index([userId])
}

model PlaybookRating {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  playbookId  String
  playbook    Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  rating      Int      // 1-5
  feedback    String?
  
  @@unique([playbookId, userId])
  @@index([playbookId])
}

// ============================================
// ANALYTICS & AGGREGATES
// ============================================

model DailyMetrics {
  id            String   @id @default(cuid())
  date          DateTime
  userId        String?  // null = company-wide
  
  @@unique([date, userId])
  
  // Lead metrics
  newLeads          Int @default(0)
  qualifiedLeads    Int @default(0)
  contactedLeads    Int @default(0)
  
  // Activity metrics
  callsMade         Int @default(0)
  callsConnected    Int @default(0)
  emailsSent        Int @default(0)
  textsSent         Int @default(0)
  visitsMade        Int @default(0)
  
  // Pipeline metrics
  proposalsSent     Int @default(0)
  proposalValue     Float @default(0)
  
  // Revenue metrics
  dealsClosed       Int @default(0)
  revenueWon        Float @default(0)
  revenueLost       Float @default(0)
  avgDealSize       Float @default(0)
  
  // Weather intel
  weatherAlerts     Int @default(0)
  stormLeads        Int @default(0)
  
  // Conversion metrics
  leadToContactRate Float @default(0)
  contactToQualRate Float @default(0)
  qualToProposalRate Float @default(0)
  proposalToCloseRate Float @default(0)
}

// ============================================
// CRM SYNC TRACKING
// ============================================

model CrmSyncLog {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  crmSource     String   // hubspot, salesforce, jobnimbus
  syncType      String   // full, incremental, webhook
  direction     String   // inbound, outbound
  
  entityType    String   // customer, interaction, deal
  entityId      String?
  crmEntityId   String?
  
  status        String   // success, failed, partial
  recordsProcessed Int   @default(0)
  recordsFailed     Int   @default(0)
  
  errorMessage  String?
  rawPayload    String?  // JSON
}

model CrmFieldMapping {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  crmSource     String   // hubspot, salesforce, jobnimbus
  entityType    String   // customer, interaction, deal
  
  localField    String
  crmField      String
  transform     String?  // JSON transformation rules
  
  isActive      Boolean  @default(true)
  
  @@unique([crmSource, entityType, localField])
}

// ============================================
// AI CONVERSATION HISTORY
// ============================================

model Conversation {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional customer context
  customerId    String?
  
  // Auto-generated from first message
  title         String?
  
  // Conversation state
  isArchived    Boolean   @default(false)
  
  messages      Message[]
  
  @@index([userId])
  @@index([customerId])
}

model Message {
  id              String       @id @default(cuid())
  createdAt       DateTime     @default(now())
  
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role            String       // user, assistant, system
  content         String
  
  // AI metadata
  model           String?      // Which AI model generated this
  toolCalls       String?      // JSON array of tool calls
  
  @@index([conversationId])
}

// ============================================
// SCHEDULED DECKS (Batch Processing Queue)
// ============================================

model ScheduledDeck {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Customer context
  customerId      String
  customerName    String

  // Template info
  templateId      String
  templateName    String

  // User tracking
  requestedById   String              // User who scheduled
  requestedBy     User                @relation("ScheduledDecksRequested", fields: [requestedById], references: [id])
  assignedToId    String?             // Rep who will use it (for manager bulk scheduling)
  assignedTo      User?               @relation("ScheduledDecksAssigned", fields: [assignedToId], references: [id])

  // Status tracking
  status          String    @default("pending") // pending, processing, completed, failed

  // Request/Response payloads (JSON)
  requestPayload  String              // Full DeckGenerationRequest as JSON
  resultPayload   String?             // Generated deck data as JSON (when completed)

  // Timing
  scheduledFor    DateTime  @default(now())  // When batch should process this
  completedAt     DateTime?

  // Error handling
  errorMessage    String?
  retryCount      Int       @default(0)

  // Metadata
  estimatedSlides Int       @default(0)
  actualSlides    Int?
  processingTimeMs Int?

  @@index([requestedById])
  @@index([assignedToId])
  @@index([status])
  @@index([scheduledFor])
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model PushSubscription {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Web Push subscription data
  endpoint  String   @unique
  p256dh    String   // Public key for encryption
  auth      String   // Auth secret
  
  // Device info (optional)
  userAgent String?
  
  @@index([userId])
}

// ============================================
// CANVASSING (Sales Rabbit Integration)
// ============================================

model CanvassingPin {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  externalId      String?   @unique
  externalSource  String    @default("salesrabbit")
  address         String
  city            String
  state           String
  zipCode         String
  latitude        Float
  longitude       Float
  firstName       String
  lastName        String
  email           String?
  phone           String?
  propertyType    String?
  yearBuilt       Int?
  roofAge         Int?
  roofType        String?
  estimatedValue  Float?
  stormEventId    String?
  lastStormDate   DateTime?
  stormSeverity   String?
  status          String    @default("new")
  outcome         String?
  priority        String    @default("medium")
  assignedRepId   String?
  assignedRepName String?
  territoryId     String?
  knockedAt       DateTime?
  appointmentDate DateTime?
  notes           String?
  photoUrls       String?
  lastSyncedAt    DateTime?
  @@index([customerId])
  @@index([status])
  @@index([zipCode])
  @@index([territoryId])
}

model CanvassingRoute {
  id                       String    @id @default(cuid())
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  name                     String
  externalId               String?
  pinIds                   String
  optimizedOrder           String?
  assignedRepId            String?
  assignedRepName          String?
  scheduledDate            DateTime?
  startTime                DateTime?
  endTime                  DateTime?
  status                   String    @default("draft")
  completedAt              DateTime?
  totalPins                Int       @default(0)
  knockedCount             Int       @default(0)
  appointmentsSet          Int       @default(0)
  notHomeCount             Int       @default(0)
  notInterestedCount       Int       @default(0)
  estimatedDurationMinutes Int?
  estimatedDistanceMiles   Float?
  actualDurationMinutes    Int?
  @@index([status])
  @@index([assignedRepId])
  @@index([scheduledDate])
}

model CanvassingSyncLog {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  source           String   @default("salesrabbit")
  syncType         String
  direction        String
  status           String
  recordsProcessed Int      @default(0)
  recordsCreated   Int      @default(0)
  recordsUpdated   Int      @default(0)
  recordsFailed    Int      @default(0)
  errorMessage     String?
  rawPayload       String?
  @@index([createdAt])
  @@index([source])
}

