generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTICATION (NextAuth.js)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CORE ENTITIES
// ============================================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Auth fields
  email         String    @unique
  emailVerified DateTime?
  password      String? // For credentials auth
  name          String
  image         String?

  // Guardian-specific fields
  role      String  @default("rep") // rep, manager, admin
  phone     String?
  avatarUrl String?
  isActive  Boolean @default(true)

  // Performance Metrics (aggregated)
  totalDeals    Int   @default(0)
  totalRevenue  Float @default(0)
  avgDealSize   Float @default(0)
  closeRate     Float @default(0)
  monthlyTarget Float @default(0)

  // Team hierarchy
  managerId   String?
  manager     User?   @relation("TeamHierarchy", fields: [managerId], references: [id])
  teamMembers User[]  @relation("TeamHierarchy")

  // Relationships
  accounts          Account[]
  sessions          Session[]
  customers         Customer[]
  interactions      Interaction[]
  notes             Note[]
  activities        Activity[]
  conversations     Conversation[]
  pushSubscriptions PushSubscription[]
  playbookUsages    PlaybookUsage[]
  playbookFavorites PlaybookFavorite[]
  playbookRatings   PlaybookRating[]
  contracts         Contract[]
  campaigns         OutreachCampaign[] @relation("CampaignCreator")
}

model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  firstName String
  lastName  String
  email     String?
  phone     String?
  altPhone  String?

  // Property Info
  address   String
  city      String
  state     String
  zipCode   String
  county    String?
  latitude  Float?
  longitude Float?

  // Property Details (gathered from APIs)
  propertyType  String? // single-family, multi-family, commercial
  yearBuilt     Int?
  squareFootage Int?
  lotSize       Float? // acres
  stories       Int?
  bedrooms      Int?
  bathrooms     Float?

  // Roof Details
  roofType      String? // asphalt shingle, metal, tile, etc.
  roofAge       Int? // estimated years
  roofSquares   Int? // roofing squares
  roofPitch     String? // 4/12, 6/12, etc.
  lastRoofWork  DateTime?
  roofCondition String? // excellent, good, fair, poor

  // Financial
  propertyValue     Float?
  estimatedJobValue Float?

  // Insurance Intel
  insuranceCarrier String?
  policyNumber     String?
  policyType       String?
  deductible       Float?
  claimHistory     Int     @default(0) // number of prior claims

  // Scores & Analytics
  leadScore       Int   @default(0) // 0-100
  urgencyScore    Int   @default(0) // 0-100  
  profitPotential Float @default(0) // estimated $
  churnRisk       Int   @default(0) // 0-100
  engagementScore Int   @default(0) // 0-100

  // Status
  status     String  @default("lead") // lead, prospect, customer, closed-won, closed-lost
  stage      String  @default("new") // new, contacted, qualified, proposal, negotiation, closed
  lostReason String?

  // Source tracking
  leadSource String? // canvassing, referral, storm, online, etc.
  referredBy String?
  campaign   String?

  // CRM Sync
  crmId       String? // External CRM ID
  crmSource   String? // hubspot, salesforce, jobnimbus
  lastCrmSync DateTime?

  // Relationships
  assignedRepId String?
  assignedRep   User?   @relation(fields: [assignedRepId], references: [id])

  interactions   Interaction[]
  weatherEvents  WeatherEvent[]
  documents      Document[]
  intelItems     IntelItem[]
  notes          Note[]
  claims         InsuranceClaim[]
  tasks          Task[]
  playbookUsages PlaybookUsage[]

  interactions  Interaction[]
  weatherEvents WeatherEvent[]
  documents     Document[]
  intelItems    IntelItem[]
  notes         Note[]
  claims        InsuranceClaim[]
  tasks         Task[]
  proposals     Proposal[]
  contracts     Contract[]
  photos        Photo[]

  @@unique([crmId])
  // Performance indexes
  @@index([assignedRepId])
  @@index([leadScore])
  @@index([status, stage])
  @@index([zipCode])
}

// ============================================
// INTELLIGENCE GATHERING
// ============================================

model IntelItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  source     String // api, web-search, manual, crm-sync, weather-api, property-api
  sourceId   String? // external reference ID
  category   String // property, insurance, weather, financial, social, news, market
  title      String
  content    String
  confidence Int     @default(80) // 0-100 confidence score
  actionable Boolean @default(false)
  priority   String  @default("medium") // low, medium, high, critical

  metadata    String? // JSON string for flexible data
  expiresAt   DateTime?
  isRead      Boolean   @default(false)
  isDismissed Boolean   @default(false)
}

model WeatherEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Can be linked to customer or standalone for area
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Location
  latitude  Float
  longitude Float
  zipCode   String?
  county    String?
  city      String?
  state     String?

  eventType String // hail, wind, tornado, hurricane, flood, thunderstorm
  eventDate DateTime
  severity  String // minor, moderate, severe, catastrophic

  // Hail specific
  hailSize     Float? // inches
  hailDuration Int? // minutes

  // Wind specific
  windSpeed     Float? // mph
  windGust      Float? // mph
  windDirection String?

  // Damage assessment
  damageReported  Boolean @default(false)
  claimFiled      Boolean @default(false)
  inspectionDone  Boolean @default(false)
  estimatedDamage Float?

  // Data source
  source        String // NOAA, weather-api, manual, hail-trace
  sourceEventId String? // External event ID
  rawData       String? // JSON

  // Affected area
  affectedRadius    Float? // miles
  affectedCustomers Int    @default(0)

  // Performance indexes
  @@index([eventDate])
  @@index([zipCode])
}

model InsuranceClaim {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  claimNumber String?
  carrier     String
  dateOfLoss  DateTime
  claimType   String // roof, siding, gutters, full-exterior, interior

  status String @default("pending") // pending, approved, denied, supplement, paid, closed

  // Financials
  initialEstimate Float?
  approvedValue   Float?
  supplementValue Float?
  totalPaid       Float?
  deductible      Float?
  acv             Float? // Actual Cash Value
  rcv             Float? // Replacement Cost Value
  depreciation    Float?

  // Adjuster info
  adjusterName     String?
  adjusterPhone    String?
  adjusterEmail    String?
  adjusterCompany  String?
  inspectionDate   DateTime?
  reinspectionDate DateTime?

  // Documents
  scopeOfWork String?
  photos      String? // JSON array of URLs

  notes String?

  // Supplement tracking
  supplementCount    Int       @default(0)
  lastSupplementDate DateTime?

  // Carrier Integration Fields
  isFiledWithCarrier Boolean   @default(false)
  carrierClaimId     String? // Carrier's internal claim ID
  carrierStatus      String? // Status from carrier API
  lastSyncAt         DateTime?
  lastSyncError      String?

  @@index([customerId])
  @@index([carrier])
  @@index([status])
}

model PropertyData {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Address (unique identifier)
  address String
  city    String
  state   String
  zipCode String

  // Property details
  parcelNumber        String?
  ownerName           String?
  ownerMailingAddress String?

  propertyType  String?
  yearBuilt     Int?
  squareFootage Int?
  lotSize       Float?
  stories       Int?
  bedrooms      Int?
  bathrooms     Float?

  // Valuation
  assessedValue Float?
  marketValue   Float?
  lastSalePrice Float?
  lastSaleDate  DateTime?

  // Roof specific
  roofType      String?
  roofMaterial  String?
  roofYear      Int?
  roofCondition String?
  roofArea      Int?

  // Building materials
  exteriorWall String?
  foundation   String?

  // Source tracking
  source      String // zillow, county-records, attom, corelogic
  sourceId    String?
  rawData     String? // JSON
  lastFetched DateTime @default(now())

  @@unique([address, city, state, zipCode])
}

// ============================================
// INTERACTIONS & ACTIVITY
// ============================================

model Interaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  type      String // call, email, text, visit, meeting, video-call
  direction String  @default("outbound") // inbound, outbound
  subject   String?
  content   String?
  outcome   String? // connected, voicemail, no-answer, scheduled, closed, callback
  sentiment String? // positive, neutral, negative

  duration     Int? // seconds
  recordingUrl String?

  nextAction     String?
  nextActionDate DateTime?

  // CRM sync
  crmId String?

  // Compound unique for upsert operations
  @@unique([customerId, type, createdAt])
}

model Task {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  assignedToId String
  createdById  String

  title       String
  description String?
  type        String // call, email, visit, follow-up, inspection, proposal, other
  priority    String  @default("medium") // low, medium, high, urgent
  status      String  @default("pending") // pending, in-progress, completed, cancelled

  dueDate     DateTime?
  completedAt DateTime?

  // Reminders
  reminderDate DateTime?
  reminderSent Boolean   @default(false)
}

model Note {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  content  String
  isPinned Boolean @default(false)
  category String? // general, objection, follow-up, insight, competitor
}

model Document {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name         String
  type         String // contract, photo, estimate, inspection, insurance, proposal, other
  category     String? // before, after, damage, signature
  url          String
  thumbnailUrl String?
  size         Int? // bytes
  mimeType     String?

  metadata String? // JSON
}

model Activity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type        String // login, view, edit, call, email, create, delete
  entityType  String // customer, lead, claim, document
  entityId    String?
  description String

  metadata  String? // JSON
  ipAddress String?
  userAgent String?
}

// ============================================
// PLAYBOOKS & KNOWLEDGE
// ============================================

model Playbook {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String?
  category    String // objection-handling, closing, discovery, presentation, follow-up
  type        String // script, checklist, guide, template

  content String // Markdown content

  // Targeting
  stage    String? // Which pipeline stage this applies to
  scenario String? // Specific scenario (e.g., "homeowner hesitant", "adjuster pushback")

  // Dynamic variables (JSON) for placeholders like {CUSTOMER_NAME}
  variables String? // JSON object defining available variables

  // Metadata
  author      String?
  isPublished Boolean @default(true)
  usageCount  Int     @default(0)
  rating      Float?

  tags String? // JSON array

  // Relationships
  usages    PlaybookUsage[]
  favorites PlaybookFavorite[]
  ratings   PlaybookRating[]
}

model PlaybookUsage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  playbookId String
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  context   String // "practice", "customer_call", "meeting", "reference", "roleplay"
  duration  Int? // seconds spent
  completed Boolean @default(false)
  outcome   String? // "closed_won", "follow_up", "no_result", "objection_handled"

  @@index([playbookId])
  @@index([userId])
  @@index([customerId])
  @@index([createdAt])
}

model PlaybookFavorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  playbookId String
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([playbookId, userId])
  @@index([userId])
}

model PlaybookRating {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  playbookId String
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating   Int // 1-5
  feedback String?

  @@unique([playbookId, userId])
  @@index([playbookId])
}

// ============================================
// ANALYTICS & AGGREGATES
// ============================================

model DailyMetrics {
  id     String   @id @default(cuid())
  date   DateTime
  userId String? // null = company-wide

  // Lead metrics
  newLeads       Int @default(0)
  qualifiedLeads Int @default(0)
  contactedLeads Int @default(0)

  // Activity metrics
  callsMade      Int @default(0)
  callsConnected Int @default(0)
  emailsSent     Int @default(0)
  textsSent      Int @default(0)
  visitsMade     Int @default(0)

  // Pipeline metrics
  proposalsSent Int   @default(0)
  proposalValue Float @default(0)

  // Revenue metrics
  dealsClosed Int   @default(0)
  revenueWon  Float @default(0)
  revenueLost Float @default(0)
  avgDealSize Float @default(0)

  // Weather intel
  weatherAlerts Int @default(0)
  stormLeads    Int @default(0)

  // Conversion metrics
  leadToContactRate   Float @default(0)
  contactToQualRate   Float @default(0)
  qualToProposalRate  Float @default(0)
  proposalToCloseRate Float @default(0)

  @@unique([date, userId])
}

// ============================================
// CRM SYNC TRACKING
// ============================================

model CrmSyncLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  crmSource String // hubspot, salesforce, jobnimbus
  syncType  String // full, incremental, webhook
  direction String // inbound, outbound

  entityType  String // customer, interaction, deal
  entityId    String?
  crmEntityId String?

  status           String // success, failed, partial
  recordsProcessed Int    @default(0)
  recordsFailed    Int    @default(0)

  errorMessage String?
  rawPayload   String? // JSON
}

model CrmFieldMapping {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  crmSource  String // hubspot, salesforce, jobnimbus
  entityType String // customer, interaction, deal

  localField String
  crmField   String
  transform  String? // JSON transformation rules

  isActive Boolean @default(true)

  @@unique([crmSource, entityType, localField])
}

// ============================================
// AI CONVERSATION HISTORY
// ============================================

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional customer context
  customerId String?

  // Auto-generated from first message
  title String?

  // Conversation state
  isArchived Boolean @default(false)

  messages Message[]

  @@index([userId])
  @@index([customerId])
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // user, assistant, system
  content String

  // AI metadata
  model     String? // Which AI model generated this
  toolCalls String? // JSON array of tool calls

  @@index([conversationId])
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model PushSubscription {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Web Push subscription data
  endpoint String @unique
  p256dh   String // Public key for encryption
  auth     String // Auth secret

  // Device info (optional)
  userAgent String?

  @@index([userId])
}

// ============================================
// GAMIFICATION SYSTEM
// ============================================

model UserGamification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique

  // XP & Level
  totalXP Int @default(0)
  level   Int @default(1)

  // Lifetime stats
  totalCalls   Int   @default(0)
  totalEmails  Int   @default(0)
  totalVisits  Int   @default(0)
  totalDeals   Int   @default(0)
  totalRevenue Float @default(0)

  // Today's stats (reset daily)
  callsToday    Int      @default(0)
  emailsToday   Int      @default(0)
  visitsToday   Int      @default(0)
  dealsToday    Int      @default(0)
  revenueToday  Float    @default(0)
  lastResetDate DateTime @default(now())

  // Streaks
  currentStreak  Int       @default(0)
  longestStreak  Int       @default(0)
  lastActiveDate DateTime?

  // Achievements (stored as JSON array of achievement IDs)
  achievements String[] @default([])

  // Daily goals progress
  dailyGoalsProgress String? // JSON object

  @@index([level])
  @@index([totalXP])
}

model XPTransaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  amount Int
  reason String // Human-readable reason
  action String // call, email, deal, achievement, streak, firstAction, etc.

  // Optional metadata
  metadata String? // JSON

  @@index([userId, createdAt])
  @@index([action])
}

model Achievement {
  id String @id @default(cuid())

  // Achievement definition
  achievementId String @unique // e.g., "first-call", "deal-100"
  name          String
  description   String
  category      String // calls, deals, revenue, streak, speed, storm
  tier          String // bronze, silver, gold, platinum, diamond
  icon          String // emoji
  requirement   Int // threshold to unlock
  xpReward      Int

  // Metadata
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)
}

// ============================================
// PROPOSALS (AI-Generated)
// ============================================

model Proposal {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdById String

  // Auto-generated proposal number
  proposalNumber String @unique @default(cuid())

  title      String
  status     String    @default("draft") // draft, sent, viewed, accepted, rejected, expired, revised
  validUntil DateTime?

  // Property snapshot (at time of proposal)
  propertyAddress String
  propertyCity    String
  propertyState   String
  propertyZip     String
  propertyType    String?
  roofType        String?
  roofAge         Int?
  roofSquares     Float?
  roofPitch       String?
  stories         Int?
  squareFootage   Int?
  yearBuilt       Int?

  // Damage assessment
  damageType        String?
  damageSeverity    String?
  damageDescription String?
  stormEventId      String?
  stormDate         DateTime?
  hailSize          Float?
  windSpeed         Float?

  // Scope of work
  scopeSummary String?
  scopeDetails String? // Markdown
  lineItems    String? // JSON array

  // Materials
  primaryMaterial  String?
  materialGrade    String?
  materialWarranty String?

  // Pricing breakdown
  materialsCost  Float   @default(0)
  laborCost      Float   @default(0)
  permitFees     Float   @default(0)
  disposalFees   Float   @default(0)
  miscFees       Float   @default(0)
  subtotal       Float   @default(0)
  discountAmount Float   @default(0)
  discountReason String?
  taxRate        Float   @default(0)
  taxAmount      Float   @default(0)
  totalPrice     Float   @default(0)

  // Alternative pricing options
  pricingOptions String? // JSON array of options

  // Insurance info
  isInsuranceClaim Boolean @default(false)
  insuranceCarrier String?
  policyNumber     String?
  deductible       Float?
  insuranceNotes   String?

  // AI-generated content
  executiveSummary   String?
  valueProposition   String?
  warrantyDetails    String?
  termsAndConditions String?

  // Source data snapshot for audit
  sourceDataSnapshot String? // JSON

  // Customer response
  viewedAt      DateTime?
  viewCount     Int       @default(0)
  respondedAt   DateTime?
  responseNotes String?

  // Attachments
  attachments String? // JSON array of attachment URLs

  @@index([customerId])
  @@index([status])
  @@index([createdById])
}

// ============================================
// CONTRACTS (Digital Signatures)
// ============================================

model Contract {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contractNumber String @unique

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  templateId String?
  template   ContractTemplate? @relation(fields: [templateId], references: [id])

  claimId String?

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  title       String
  description String?

  // Contract content (HTML)
  content      String
  termsContent String?

  status String @default("draft") // draft, sent, viewed, signed, completed, cancelled, expired

  // Financial
  totalAmount    Float
  depositAmount  Float   @default(0)
  depositPercent Float?
  balanceDueOn   String? // "completion", date, etc.
  paymentTerms   String?

  // Scope
  scopeOfWork  String?
  materials    String? // JSON array
  laborDetails String?

  // Timeline
  estimatedStartDate DateTime?
  estimatedEndDate   DateTime?
  warrantyTerms      String?

  // Expiration
  expiresAt DateTime?

  // Sending
  sentAt  DateTime?
  sentVia String? // email, sms, in-person

  // Viewing
  viewedAt DateTime?

  // Customer signature
  customerSignature String? // Base64 image
  customerSignedAt  DateTime?
  customerSignedIp  String?
  customerInitials  String? // Base64 image
  signedLatitude    Float?
  signedLongitude   Float?
  signedAddress     String?

  // Rep signature
  repSignature String? // Base64 image
  repSignedAt  DateTime?

  // Audit trail
  auditLog String? // JSON array of events

  @@index([customerId])
  @@index([status])
  @@index([createdById])
}

model ContractTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  description String?
  category    String? // residential, commercial, insurance

  content      String // HTML template with placeholders
  termsContent String?

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  contracts Contract[]
}

// ============================================
// COMPETITOR INTELLIGENCE
// ============================================

model Competitor {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name         String  @unique
  displayName  String?
  website      String?
  phone        String?
  headquarters String?

  // Service info (JSON arrays stored as strings)
  serviceAreas  String? // JSON array of states/regions
  yearFounded   Int?
  employeeCount Int?

  pricingTier    String  @default("mid") // budget, mid, premium, luxury
  specialties    String? // JSON array
  certifications String? // JSON array

  // Intel
  strengths    String?
  weaknesses   String?
  salesTactics String?
  pricingNotes String?

  // Metrics
  marketShare    Float? // 0-100
  reputation     Int? // 1-5
  avgReviewScore Float? // 0-5
  reviewCount    Int?

  isActive Boolean @default(true)

  // Relations
  activities CompetitorActivity[]

  @@index([pricingTier])
}

model CompetitorActivity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  competitorId String
  competitor   Competitor @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  customerId String?

  reportedById String

  activityType String // sighting, quote, won_deal, lost_deal, canvassing, marketing, price_intel

  // Location
  address   String?
  city      String?
  state     String?
  zipCode   String?
  latitude  Float?
  longitude Float?

  description String?

  // Price intel
  quotedPrice     Float?
  priceComparison String? // lower, similar, higher

  // Outcome (for won/lost deals)
  outcome       String?
  outcomeReason String?
  dealValue     Float?

  // Photo evidence
  photoUrl String?
  hasPhoto Boolean @default(false)

  isVerified Boolean @default(false)

  @@index([competitorId])
  @@index([activityType])
  @@index([createdAt])
}

// ============================================
// OUTREACH CAMPAIGNS
// ============================================

model OutreachCampaign {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  description String?

  createdById String
  createdBy   User   @relation("CampaignCreator", fields: [createdById], references: [id])

  // Trigger configuration
  triggerType String // storm, manual, scheduled
  stormTypes  String? // JSON array of storm types
  minSeverity String? // minor, moderate, severe

  // Targeting
  targetZipCodes String? // JSON array
  targetStates   String? // JSON array
  excludeRecent  Int     @default(30) // Exclude customers contacted in last N days

  // Channels
  enableSms   Boolean @default(true)
  enableEmail Boolean @default(true)

  // Templates
  smsTemplate   String?
  emailSubject  String?
  emailTemplate String?

  // Timing
  delayMinutes Int     @default(0)
  sendWindow   String? // JSON object with start/end hours

  // Status
  isActive   Boolean @default(true)
  isArchived Boolean @default(false)

  // Stats (aggregated)
  totalSent      Int @default(0)
  totalDelivered Int @default(0)

  // Relations
  executions CampaignExecution[]

  @@index([triggerType])
  @@index([isActive])
}

model CampaignExecution {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  campaignId String
  campaign   OutreachCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  triggerType String // storm, manual, scheduled
  triggerId   String? // ID of storm event or schedule
  triggerData String? // JSON with trigger details

  targetZipCodes String? // JSON array

  status String @default("pending") // pending, processing, completed, failed, cancelled

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  // Results
  affectedCustomers Int @default(0)
  smsSent           Int @default(0)
  smsDelivered      Int @default(0)
  smsFailed         Int @default(0)
  emailSent         Int @default(0)
  emailDelivered    Int @default(0)
  emailFailed       Int @default(0)

  errorMessage String?

  // Relations
  messages OutreachMessage[]

  @@index([campaignId])
  @@index([status])
}

model OutreachMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  executionId String
  execution   CampaignExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  customerId String

  channel   String // sms, email
  recipient String // phone or email
  subject   String? // For email only
  body      String

  status String @default("pending") // pending, queued, sent, delivered, opened, clicked, failed, bounced, unsubscribed

  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?

  // Provider tracking
  externalId   String? // Provider message ID
  errorCode    String?
  errorMessage String?

  @@index([executionId])
  @@index([customerId])
  @@index([status])
}

// ============================================
// PHOTOS (GPS-Tagged)
// ============================================

model Photo {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // File info
  filename     String
  originalName String?
  url          String
  thumbnailUrl String?
  size         Int? // bytes
  mimeType     String  @default("image/jpeg")

  // Relationships
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  claimId String?

  uploadedById String

  // GPS Location
  latitude  Float?
  longitude Float?
  altitude  Float?
  accuracy  Float? // meters
  heading   Float? // degrees

  // Reverse geocoded address
  capturedAddress String?
  capturedCity    String?
  capturedState   String?
  capturedZipCode String?

  // Categorization
  category    String  @default("general") // general, damage, before, after, roof, siding, gutter, interior, signature, adjuster-meeting, other
  tags        String? // JSON array
  description String?

  // Damage info
  damageType     String? // hail, wind, water, wear, impact
  damageSeverity String? // minor, moderate, severe

  // Device info
  deviceType  String? // mobile, tablet, desktop
  deviceModel String?

  @@index([customerId])
  @@index([category])
  @@index([claimId])
}

// ============================================
// CARRIER INTEGRATION
// ============================================

model CarrierConfig {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  carrierCode String  @unique
  carrierName String
  displayName String?

  // API Configuration
  apiEndpoint   String?
  apiKey        String?
  apiSecret     String?
  clientId      String?
  clientSecret  String?
  accessToken   String?
  refreshToken  String?
  tokenExpiry   DateTime?
  webhookSecret String?

  // Features
  supportsDirectFiling   Boolean @default(false)
  supportsStatusUpdates  Boolean @default(false)
  supportsDocumentUpload Boolean @default(false)

  isTestMode Boolean @default(true)
  isActive   Boolean @default(true)

  @@index([carrierCode])
}

model CarrierSyncLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  carrierCode String
  claimId     String?

  syncType  String // status_check, file_claim, upload_document, webhook
  direction String // inbound, outbound

  status String // success, failed, partial

  requestData  String? // JSON
  responseData String? // JSON
  errorMessage String?

  duration Int? // milliseconds

  @@index([carrierCode])
  @@index([claimId])
  @@index([createdAt])
}

// ============================================
// OUTREACH TEMPLATES
// ============================================

model OutreachTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  description String?
  category    String // storm, follow-up, promotional, seasonal
  channel     String // sms, email

  // Template content
  subject  String? // For email only
  body     String
  htmlBody String? // For email HTML version

  // Personalization
  variables String? // JSON array of variable names used

  isDefault  Boolean @default(false)
  isActive   Boolean @default(true)
  usageCount Int     @default(0)

  @@unique([name, channel])
  @@index([category])
  @@index([channel])
}
